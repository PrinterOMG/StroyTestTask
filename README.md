# Тестовое задание на позицию "Python разработчик"

---

## Задание

### Общая информация:
Вам необходимо разработать REST API для управления продуктами на
торговой площадке. API должно позволять пользователям добавлять,
обновлять, удалять и получать информацию о продуктах, а также получать
информацию о категориях и фильтровать продукты по различным параметрам.

### Требования к решению:
Обязательные технические требования:
- код размещен и доступен в публичном репозитории на GitHub
- оформлена инструкция по запуску сервиса и взаимодействия с
проектом (Markdown по необходимости)
- сервис реализован с использованием FastAPI

### Необязательные технические требования (по возрастанию трудоемкости):
- Использовать можно любые БД (реляционные, нереляционные), как и
способ доступа и управления данными внутри (сырые sql или orm, если
выбрали реляционную модель)
- зависимости зафиксированы менеджером зависимостей poetry
- написаны тесты с использованием pytest
- реализована возможность собирать и запускать контейнер с сервисом
docker

---

## Описание

Проект написан в чистой архитектуре. \
Используемый стек:
- `Python 3.12`
- `FastAPI`
- `Dishka`
- `SQLAlchemy`
- `Alembic`
- `PyTest`
- `Pydantic`

Также используется `pre-commit` с `ruff` для проверки и форматирования кода\
Для управления зависимостями используется `poetry`\
Для запуска проекта используется `docker`

Возможности API:
- CRUD операции для категорий
- CRUD операции для продуктов
- Фильтрация продуктов по различным параметрам

Так что, все обязательные и необязательные требования к решению должны быть выполнены.

### Почему Dishka, а не FastAPI Depends
`Dishka` - это удобный DI фреймворк, он может всё что `FastAPI Depends` и даже больше.

Но в отличие от `FastAPI Depends`:
- `Dishka` можно использовать не только в `FastAPI`, но и с другими фреймворками в рамках одного проекта
- `Dishka` не требует прописывать `Depends` по всем слоям приложения, что лучше подходит для чистой архитектуры
- `Dishka` Не намешивает части запроса и зависимости в хэндлере, и они не попадают в OpenAPI.
(FastAPI Depends иногда подкидывает в Query параметры лишние аргументы из зависимостей, что не всегда явно корректно)
- С `Dishka` удобнее тестировать, за счёт разделения провайдеров и гибких `scope`

Также в таком проекте будет просто заменить FastAPI на другой фреймворк.

### Структура проекта
В папке `tests` находятся тесты.\
В папке `docker` находятся docker-контейнеры и настройки для них.\
В папку `products_app` находится само приложение.

Внутри `products_app`:
- `application` - там лежат интерфейсы, дто и юзкейсы.
- `contollers` - там лежат хэндеры и схемы FastAPI.
- `domain` - там лежат модели и сервисы доменного слоя.
- `infra` - там лежат конкретные реализации интерфейсов, а также БД, миграции и всё подобное.
- `ioc` - там лежат зависимости.
- `config.py` - настройки приложения
- `main.py` - точка входа в приложение
- `openapi.py` - дополнительное описание для OpenAPI


### Функционал
Так как в задании не было ни домена, ни каких-то четких требований к возможностям торговой площадки, попытался сделать
универсальный вариант.

#### Категории
У категорий есть дочерние категории.\
Для удобства фронтенда, есть эндпоинт для получения всех корневых категорий вместе с дочерними категориями в виде дерева.

Также есть стандартные CRUD операции для категорий.

#### Товары
У товаров помимо стандартных полей, есть словарь в формате JSONB для хранения произвольных атрибутов.
Так пользователи могут добавлять любые необходимые атрибуты к товарам.

Для фильтрации товаров есть специальный эндпоинт. Фильтрация работает на своём микро-языке, который можно расширять.
Фильтрация работает как по полям самого товара, так и по кастомным атрибутам.\
Работу системы фильтрации можно увидеть в тестах и описании эндпоинта.

Но сейчас есть проблема, что неясно какие вообще есть кастомные атрибуты у товаров, допустим, в рамках категории.
Решить это можно несколькими способами. Как вариант, вынести список общих атрибутов для товаров в категорию и разрешить
фильтрацию только по ним.

Для товаров есть стандартные CRUD операции.

#### Что можно улучшить
Возможно, для товаров было бы удобнее использовать `MongoDB`, чтобы было удобнее работать с кастомными атрибутами, но тут
нужно больше информации по бизнес-требованиям, чтобы сделать окончательный анализ.

В идеале нужно задокументировать код, настроить логирование, мониторинг и другое по необходимости.

Явно нужна возможность полнотекстового поиска и больше возможностей для работы с фильтрами. Картинки к товарам.

Также следует переписать систему фильтрации, на более удобную и расширяемую +
возможность узнать доступные атрибуты для фильтрации.
Сейчас расширять именно в коде будет не очень удобно.

Тесты можно распределить удобнее.

Настройка окружения для прода: скрыть документацию, добавить `ratelimit`, кеширование и другое.\
Хотя за всё это может отвечать API Gateway.

Прописать все DTO и написать сервисы, чтобы больше соответствовать чистой архитектуре.

Добавить `mypy`, настроить `CI/CD`.

Но в рамках тестового задания всё это делать займёт слишком много времени)

## Запуск

Для запуска проекта должен быть установлен `docker` и, по желанию, `make`.

Для `dev` окружения должны быть свободны порты `8000` и `5433`. Для `prod` - только `8000`.

Если есть `make`, то достаточно прописать в корневой директории:
```shell
# Для запуска dev окружения. Там проброшены порты для базы данных, включен reload в uvicorn и примаунчена папка проекта
make up_dev

# Для запуска prod окружения.
make up_prod
```

Если нет `make`:
```shell
# Для dev окружения
docker compose -f docker-compose.yml -f docker-compose.dev.yml up --build

# Для prod окружения
docker compose -f docker-compose.yml -f docker-compose.prod.yml up --build
```

Если это первый запуск, то нужно будет также провести миграции базы данных командой:
```shell
# Если есть make
make migrate

# Если нет make
docker exec products_app alembic upgrade heads
```

После запуска доступ к API можно будет получить по адресу http://127.0.0.1:8000

Документация: http://127.0.0.1:8000/docs и http://127.0.0.1:8000/redoc

---

## Тесты

### Запуск
Для запуска тестов нужны установленные `Python 3.12`, `Poetry` и `Docker`.

```shell
# Установка зависимостей
poetry install
# Запуск тестов
poetry run pytest tests
```

### Описание

Тесты прогоняются с использованием тестовой БД, которая автоматически поднимается в docker-контейнере при запуске тестов. \
Для запуска тестовой базы используется `docker-compose` файл из папки `tests`.\
Также для тестов используется другой `.env` файл, он берётся из `tests/.env.test`.\

В тестах взаимодействие с БД происходит через gateways, что делает тесты не очень хрупкими.\
За счёт тестов вместе с БД мы сразу проверяем, что gateways правильно работают.

Если бы в зависимостях были внешние API, то их бы уже точно надо было замокать.

---

## Контакты
- [Telegram - @printeromg](https://t.me/printeromg)
- [Почта - kitaev.gregory@gmail.com](mailto:kitaev.gregory@gmail.com)
